<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>文件上传打印</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<h2>上传文件打印</h2>
<input type="file" id="fileInput" />
<button onclick="uploadFile()">上传打印</button>

<script>
const SUPABASE_URL = "https://jesixxdapfftvxkfndup.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Implc2l4eGRhcGZmdHh2a2ZuZHVwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3OTA1OTUsImV4cCI6MjA3MjM2NjU5NX0.ReMC_yE52E4s0MZDuXj6UUmTHoefr7uWZIUKugW-PSo";

const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

async function uploadFile() {
  const file = document.getElementById('fileInput').files[0];
  if(!file) { alert("请选择文件"); return; }

  // 上传到 Storage 'print-web/latest' 文件夹，upsert: true 会覆盖同名文件
  const { error } = await supabase.storage.from('print-web').upload(`latest/${file.name}`, file, { upsert: true });
  if(error) { alert("上传失败：" + error.message); return; }

  // 获取最新文件列表
  let { data: files } = await supabase.storage.from('print-web').list('latest');
  files.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

  // 保留最新3个文件
  if(files.length > 3){
    const toDelete = files.slice(3);
    for(const f of toDelete){
      await supabase.storage.from('print-web').remove([`latest/${f.name}`]);
    }
  }

  alert("上传成功，文件已加入打印队列");
}
</script>
</body>
</html>
